{% extends 'template.html' %}
{% block head %}
    {% parent %}
    <script type="text/javascript" src="/tokeninput.js"></script>
    <link rel="stylesheet" href="/token-input.css" type="text/css" />
    <link rel="stylesheet" href="/token-input-fb.css" type="text/css" />
    <style>
    </style>
    <script>

    function isValidEmailAddress(emailAddress) {
        var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
        return pattern.test(emailAddress);
    };

        $(document).ready(function(){

            $("[rel='popover']").popover({
                trigger: "hover",
                html: true,
                delay: { show: 1000, hide: 200 }
            });
            $("A.matchInvitation").click(function(){
                $("#sendInvitation").modal("show");
                $("#sendInvitation").attr("mid", $(this).parents("ul").attr("mid"));
            });

            $("A.joinMatch").click(function(){
                actionMatch("joinMatch", $(this).parents("ul").attr("mid"));
            });

            $("#text-invitation").tokenInput("/getContacts", {
                theme: "facebook",
                deleteText: "&#x2603;",
                hintText: '{{__("Type your friend nick")}}',
                noResultsText: '{{__("No user found, do you want invite not registered friend? type his/her email...")}}',
                searchingText: '{{__("Searching...")}}',
                searchDelay: 500,
                minChars: 3,
                tokenLimit: 5,
                preventDuplicates: true,
                allowFreeTagging: true,
                zindex: 9999,
                propertyToSearch: "nick",
                onFreeTaggingAdd: function(hidden_input, token){
                    if ( !isValidEmailAddress(hidden_input) ){
                        $("#email_error").html(hidden_input+'{{__(" is not a valid email!")}}').css("visibility", "visible").delay(1000).animate({visibility: "hidden", opacity: 0}, 1000);
                        return undefined;
                    }
                    token = hidden_input;
                    return token;
                }
            });

            $("#sendInvitation").bind("hidden", function(){
                $("#text-invitation").tokenInput("clear");//$("ul.token-input-list-facebook li.token-input-token-facebook").remove();
            });

            $("IMG.playerImage, IMG.playMatchIcon, IMG.restoreMatchIcon").tooltip();

        });

        $(document).on("click", "IMG.playMatchIcon", function(){
          actionMatch("startJoinMatch", $(this).attr("mid"), true);
        });
        
        $(document).on("click", "IMG.restoreMatchIcon", function(){
            actionMatch("restoreJoinMatch", $(this).attr("mid"), true);
        });

        //--------------------------------------------

        //  FUNZIONI
        /*
        var closeOtherPopovers = function(id){
            $("DIV[rel='popover'][id!='popover"+id+"']").popover("hide");
        };
        */

        function actionMatch(actionUrl, matchId, newPage, player_color){
            var form = $("<form method='POST' action='/"+actionUrl+"' id='joinMatchForm' "+(newPage ? " target='_blank_"+matchId+"' " : "")+">\
                                <input type='hidden' name='matchId' value='"+matchId+"'>\
                                <input type='hidden' name='_csrf' value='{{token}}'>\
                                <input type='hidden' name='player_color' value='"+player_color+"'>\
                            </form>");
            form.appendTo($('body'));
            form.submit();
        }

        function confirmJoinMatch(matchId){

          makeAjaxCall("/getColoursAvailable", "POST", {matchId: matchId, _csrf: '{{token}}'}, function(data){
            var script = '$("#confirmBox select#playerColorMatch").empty();';
            for(var idx=0; idx < data.length; idx++){
              script += '$("<option value=\''+data[idx].color+'\'>'+data[idx].name+'</option>").appendTo($("#confirmBox select#playerColorMatch"));';
            }
            showConfirmBox('{{__("Confirm")}}', '{{__("Are you sure to join this match?")}}<br/>\
                        <small>Scegli il colore:</small> <select id="playerColorMatch"></select>', function(){
                actionMatch("joinMatch", matchId, false, $("#confirmBox select#playerColorMatch").val());
            });
            eval(script);
          }, function(err){
            showAlertBox("Error", err.responseText);
          });


        }

        function confirmLeaveMatch(matchId){
            showConfirmBox('{{__("Sure")}}'+'???', '{{__("Really want to quit the match?")}}', function(){
                actionMatch("leaveMatch", matchId);
            });
        }

        $(document).on("click", "#modalInvitationSender", function(){

            makeAjaxCall("/sendInvitationToMatch", "POST",
                {
                    matchId: $("#sendInvitation").attr("mid"),
                    contacts: $("#text-invitation").tokenInput("get"),
                    _csrf: '{{token}}'
                },
                function(data){
                    showAlertBox('{{__("Notifications")}}', '{{__("You invitations are sent!")}}');
                },
                function(err){
                    showAlertBox('{{__("Notifications Error")}}', '{{__("Mmmmm.... there are some little problems...<br/>Please, try again...")}}');
                },
                function (){
                    $("#sendInvitation A.btn").attr("disabled", "disabled");
                },
                function(){
                    $("#sendInvitation").modal("hide");
                    $("#sendInvitation A.btn").removeAttr("disabled");
                }
            );

        });

        function makeAjaxCall(url, type, data, successFn, errorFn, beforeFn, completeFn){
            $.ajax({ cache: false
                       , dataType: "json"
                       , data: data
                       , url: url
                       , type: type
                       , error: errorFn
                       , success: successFn
                       , before: beforeFn
                       , complete: completeFn
                       });
        }

        function showAlertBox(title, message){
            $("#alertBox DIV.modal-header h3").html(title);
            $("#alertBox DIV.modal-body p").html(message);
            $("#alertBox").modal("show");
        }

        function showConfirmBox(title, message, callback){
            $("#confirmBox DIV.modal-header h3").html(title);
            $("#confirmBox DIV.modal-body p").html(message);
            $("#confirmBox").modal({
                show: true,
                backdrop: "static"
            });

            $("#confirmBox A#confirmBoxNo").unbind("click").click(function(){
                $("#confirmBox").modal("hide");
            });
            $("#confirmBox A#confirmBoxYes").unbind("click").click(function(){
                callback.call(this);
            });

        }

        $(document).on("show", "#newMatch", function(){
          makeAjaxCall("/allColours", "GET", {},
          function(data){
            if ( data ){
              for(var idx in data){
                var d = data[idx];
                $("<option value='"+d.color+"'>"+d.name+"</option>").appendTo($("#newMatch select#player_color"));
              }
            }
          },
          function(err){
            alert("err: "+err.responseText);
          });
        });
        //--------------------------

    </script>
{% endblock %}
{%block content%}
<div class="hero-unit" style="margin-top:70px;padding:10px 60px;">
    <div class="row-fluid">
        <h2 style="float:left;">
            Welcome {{user.name.first}} {{user.name.last}} ({{user.nick}})
        </h2>
        <div class="well" style="float:right;">
            <a href='#newMatch' class='btn btn-large btn-primary' data-toggle="modal" role="button">{{__("Create new match")}}</a>
            <a href='/logout' class='btn btn-large btn-inverse'>{{__("Logout")}}</a>
        </div>
    </div>
    <div class="row-fluid">
        {% if msg_title %}
            <div class="alert alert-block alert-{{msg_level}}">
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <h4>{{msg_title}}</h4>
              {{msg_body}}
            </div>
        {% endif %}
        <ul class="nav nav-tabs" id="matches" style="margin:0px;margin-left:30px;">
            <li class="active"><a href="#myMatches" data-toggle="tab">{{__("Match you are playing")}}</a></li>
            <li><a href="#availableMatches" data-toggle="tab">{{__("Matches availables")}}</a></li>
            <li><a href="#matchesCompleted" data-toggle="tab">{{__("Your matches completed")}}</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active matches" id="myMatches">
                <h3>{{__("Match you are playing")}}</h3>
                <table class="table table-striped table-condensed table-hover">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>#</th>
                            <th>{{__("Created at")}}</th>
                            <th>{{__("Owner")}}</th>
                            <th>{{__("Players")}}</th>
                            <th>{{__("Status")}}</th>
                        </tr>
                    </thead>
                    <tbody class='match'>
                        {% for m in myMatchList %}
                            {% if !m.winner %}
                                <tr>
                                    <td>
                                        <div class="btn-group">
                                            <a class="btn dropdown-toggle btn-small" data-toggle="dropdown" href="#">
                                                {{__("Actions")}}
                                                <span class="caret"></span>
                                            </a>
                                            <ul id="menu1" class="dropdown-menu" role="menu" mid='{{m._id}}'>
                                              <li role="presentation"><a role="menuitem" class="matchInvitation" tabindex="-1" href="javascript:void(0);">{{__("Send invitation")}}</a></li>
                                              <li role="presentation" class="divider"></li>
                                                {% if m.masterPlayer._id == user.id %}  <!-- se sono il masterPlayer, posso cancellare il match -->
                                                    <li role="presentation"><a role="menuitem" tabindex="-1" class="deleteMatch" href="#">{{__("Remove match")}}</a></li>
                                                {% endif %}
                                                {% if m.masterPlayer._id != user.id && m.running == false%} <!-- posso uscire da un match solo se non ne sono proprietario -->
                                                    <li role="presentation"><a role='menuitem' tabindex="-1" class="exitFromMatch" href="javascript:void(0);" onClick='confirmLeaveMatch("{{m._id}}");'>{{__("Get out from match")}}</a></li>
                                                {% endif %}
                                              <li role="presentation"><a role='menuitem' tabindex="-1" class="playMatch" href="#">{{__("Play")}}</a></li>
                                            </ul>
                                          </div>
                                    </td>
                                    <td><a href='#' id="{{m._id}}" rel="popover" data-toggle="popover" data-placement="right" title="" data-content="{{m.infos}}" data-original-title='{{__("Match Infos")}}'>{{m.name}}</a></td>
                                    <td>{{m.started_at|date('j F Y H:i:s', 1)}}</td>
                                    <td>{{m.masterPlayer.nick}}</td>
                                    <td>
                                        {% for p in m.players %}
                                            <img src='seatBusy' class='playerImage' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title="{{p.player.nick}}">
                                        {% endfor %}
                                        {% for idx in m.free|buildArray %}
                                            <img src='seatFree' border='0'>
                                        {% endfor %}
                                    </td>
                                    <td>{% if m.running == false && m.free > 0 %}
                                            {{__("waiting for players")}}
                                        {% else if m.running == false && m.free == 0 %}
                                            {{__("Ready to play")}} <img mid='{{m._id}}' class='playMatchIcon' src='/play' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title='{{__("You can get into the match and wait for the owner orders the start of hostilities!")}}'>
                                        {% else if m.running == true && m.pause == false %}
                                            {{__("Ready to play")}} <img mid='{{m._id}}' class='restoreMatchIcon' src='/play' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title='{{__("Restore match!")}}'>
                                        {% else if m.pause %}
                                            {{__("pause")}}
                                        {% else %}
                                            {{__("playing")}}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                <p style='height:25px;'></p>
            </div>
            <div class="tab-pane matches" id="availableMatches">
                <h3>{{__("Match availables")}}</h3>
                <table class="table table-striped table-condensed table-hover">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>#</th>
                            <th>{{__("Created at")}}</th>
                            <th>{{__("Owner")}}</th>
                            <th>{{__("Players")}}</th>
                            <th>{{__("Status")}}</th>
                        </tr>
                    </thead>
                    <tbody class='match'>
                        {% for m in allMatches %}
                            <tr>
                                <td>
                                    <div class="btn-group">
                                        <a class="btn dropdown-toggle btn-small" data-toggle="dropdown" href="#">
                                            {{__("Actions")}}
                                            <span class="caret"></span>
                                        </a>
                                        <ul id="menu1" class="dropdown-menu" role="menu" mid='{{m._id}}'>
                                          <li role="presentation"><a role="menuitem" class="joinMatch" tabindex="-1" href="javascript:void(0);">{{__("Join this match")}}</a></li>
                                        </ul>
                                      </div>
                                </td>
                                <td><a href='#' id="{{m._id}}" rel="popover" data-toggle="popover" data-placement="right" title="" data-content="{{m.infos}}" data-original-title='{{__("Match Infos")}}'>{{m.name}}</a></td>
                                <td>{{m.started_at|date('j F Y H:i:s', 1)}}</td>
                                <td>{{m.masterPlayer.nick}}</td>
                                <td>
                                    {% for p in m.players %}
                                        <img src='seatBusy' class='playerImage' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title="{{p.player.nick}}">
                                    {% endfor %}
                                    {% for idx in m.free|buildArray %}
                                        <a href='javascript:confirmJoinMatch("{{m._id}}");'><img src='seatFree' class='playerImage' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title='{{__("Seat Free! Join us!")}}'></a>
                                    {% endfor %}
                                </td>
                                <td>{% if m.running == false && m.free > 0 %}
                                        waiting for players <a mid='{{m._id}}' href='javascript:confirmJoinMatch("{{m._id}}");' class='btn btn-success btn-mini' src='/play' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title='{{__("You can get into the match and wait for the owner orders the start of hostilities!")}}'>{{__("Join in")}}</a>
                                    {% else if m.pause %}
                                        pause
                                    {% else %}
                                        playing
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <p style='height:25px;'></p>
            </div>
            <div class="tab-pane" id="matchesCompleted">
                <h3>{{__("Your matches completed")}}</h3>
                <table class="table table-striped table-condensed table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>{{__("Created at")}}</th>
                            <th>{{__("Owner")}}</th>
                            <th>{{__("Players")}}</th>
                            <th>{{__("Winner")}}</th>
                            <th>{{__("Match")}}</th>
                        </tr>
                    </thead>
                    <tbody class='match'>
                        {% for m in myMatchList %}
                            {% if m.winner %}
                                <tr>
                                    <td><a href='#' id="{{m._id}}" rel="popover" data-toggle="popover" data-placement="right" title="" data-content="{{m.infos}}" data-original-title='{{__("Match Infos")}}'>{{m.name}}</a></td>
                                    <td>{{m.started_at|date('j F Y H:i:s', 1)}}</td>
                                    <td>{{m.masterPlayer.nick}}</td>
                                    <td>
                                        {% for p in m.players %}
                                            <img src='seatBusy' class='playerImage' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title="{{p.player.nick}}">
                                        {% endfor %}
                                        {% for idx in m.free|buildArray %}
                                            <img src='seatFree' border='0'>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        {{m.winner.nick}}
                                    </td>
                                    <td>
                                        {{__("View match")}} <img mid='{{m._id}}' class='restoreMatchIcon' src='/play' border='0' data-toggle="tooltip" data-placement="top" title="" data-original-title='{{__("View this match final status!")}}'>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                <p style='height:25px;'></p>
            </div>
        </div>
    </div>
</div>

<div id="newMatch" class="modal hide fade">
    <form method="POST" action="/createNewMatch">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>{{__("New Match")}}</h3>
      </div>
      <div class="modal-body">
            <div class="control-group">
              <label class="control-label"  for="name">{{__("Match name")}}</label>
              <div class="controls">
                <input autofocus pattern=".{3,15}" type="text" id="name" name="name" placeholder="mymatch" value="" class="input-xlarge">
                <p class="help-block">{{__("If empty, it will filled with UUID")}} <span class='verysmall'>{{__("min 3, max 15 chars")}}</span></p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label"  for="num_players">{{__("Number of players")}}</label>
              <div class="controls">
                <select name="num_players">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
                <p class="help-block">{{__("Select number of players will play the match")}}</p>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label"  for="player_color">{{__("Player color")}}</label>
              <select name="player_color" id="player_color">
              </select>
            </div>
            <p class="text-warning">{{__("You will start match when all players are online at the same time")}}</p>
            <input type="hidden" name="_csrf" value="{{token}}">
      </div>
      <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">{{__("Close")}}</a>
        <input type="submit" class="btn btn-large btn-danger" value='{{__("Create it!")}}'>
      </div>
    </form>
</div>

<div id="sendInvitation" class="modal hide fade" mid=''>
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>{{__("Send invitation")}}</h3>
    </div>
    <div class="modal-body">
        <p class="lead">{{__("Enter your friend nick to send him an invitation to join this match")}}</p>
        <p class="muted">{{__("If your friend is not registered, type his email for invite him!")}}</p>
        <p id="email_error" style="height:20px;color:red;"></p>
        <input type="text" class="span3" style="width:400px;height:200px;" id="text-invitation" style="margin: 0 auto;" autocomplete="off">
    </div>
    <div class="modal-footer">
        <a href="javascript:void(0);" class="btn" data-dismiss="modal">{{__("Cancel")}}</a>
        <a href="javascript:void(0);" class="btn btn-large btn-danger" id="modalInvitationSender">{{__("Send invitations!")}}</a>
    </div>
</div>

<div id="confirmStartMatch" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>{{__("Send invitation")}}</h3>
    </div>
    <div class="modal-body">
        <p class="lead">{{__("Do you want to invite <span id='user'></span> to join this game?")}}</p>
        <p class="muted">{{__("Your friend will receive an invitation, then it will be free to accept or not...")}}</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">{{__("Close")}}</a>
        <a href="#" class="btn btn-large btn-danger" value='{{__("Send it!")}}'></a>
    </div>
</div>

<div id="alertBox" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3></h3>
    </div>
    <div class="modal-body">
        <p class="lead"></p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">{{__("Close")}}</a>
    </div>
</div>

<div id="confirmBox" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3></h3>
    </div>
    <div class="modal-body">
        <p class="lead"></p>
    </div>
    <div class="modal-footer">
        <a href="javascript:void(0);" class="btn btn-large" id="confirmBoxNo">{{__("No")}}</a>
        <a href="javascript:void(0);" class="btn btn-success btn-large" id="confirmBoxYes">{{__("Yes")}}</a>
    </div>
</div>

{%endblock%}